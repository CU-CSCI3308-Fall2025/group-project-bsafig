{{> message}}

<div class="container mt-4" style="max-width: 700px;">
  <h2 class="mb-4 text-center">Recent Reviews</h2>

  {{#if reviews.length}}
    {{#each reviews}}
      <div class="card mb-3 shadow-sm rounded-3">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <img src="{{this.profile_picture_url}}" 
                 alt="Profile Picture" 
                 class="rounded-circle me-2"
                 width="40" height="40">
            <strong>
              <a href="/profile/{{this.username}}" class="text-decoration-none">{{this.username}}</a>
            </strong>
          </div>

          <h5 class="card-title">{{this.music_name}}</h5>
          <p class="card-text">{{this.content}}</p>
          <p class="text-muted mb-0">Rating: {{this.rating}} / 10</p>
          <small class="text-muted">{{this.created_at}}</small>

          <hr>

          <!-- Inline Reactions + Comments Toggle -->
          <div class="d-flex align-items-center gap-3 mb-2">
            <button class="reaction-btn" data-review-id="{{this.review_id}}" data-type="like">ğŸ‘ <span id="review-like-count-{{this.review_id}}">0</span></button>
            <button class="reaction-btn" data-review-id="{{this.review_id}}" data-type="dislike">ğŸ‘ <span id="review-dislike-count-{{this.review_id}}">0</span></button>
            <button class="btn btn-outline-secondary btn-sm comment-toggle" data-review-id="{{this.review_id}}">
              ğŸ’¬ Comments (<span id="comment-count-{{this.review_id}}">0</span>)
            </button>
          </div>

          <!-- Collapsible Comments -->
          <div id="comments-wrapper-{{this.review_id}}" class="collapse">
            <div id="comments-{{this.review_id}}" class="comments mb-2"></div>

            <form class="comment-form" data-review-id="{{this.review_id}}">
              <div class="input-group mb-2">
                <input type="text" name="content" class="form-control" placeholder="Add a comment..." required>
                <button class="btn btn-primary" type="submit">Post</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {{/each}}
  {{else}}
    <p class="text-center text-muted">No reviews have been posted yet.</p>
  {{/if}}
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const forms = document.querySelectorAll('.comment-form');
  const reactionButtons = document.querySelectorAll('.reaction-btn');

  // Initialize comment counts
  for (const form of forms) {
    const reviewId = form.dataset.reviewId;
    await updateComments(reviewId, { loadOnlyCount: true });
    await updateReactions(reviewId);
  }

  // Toggle comments dropdown
  document.querySelectorAll('.comment-toggle').forEach(btn => {
    btn.addEventListener('click', async () => {
      const reviewId = btn.dataset.reviewId;
      const wrapper = document.getElementById(`comments-wrapper-${reviewId}`);
      wrapper.classList.toggle('show');

      if (wrapper.classList.contains('show')) {
        await updateComments(reviewId);
      }
    });
  });

  // Handle posting comment
  forms.forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const reviewId = form.dataset.reviewId;
      const input = form.querySelector('input[name="content"]');
      const content = input.value.trim();
      if (!content) return;

      const res = await fetch('/add-comment', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ review_id: reviewId, content })
      });
      const data = await res.json();
      if (data.success) {
        input.value = '';
        await updateComments(reviewId);
      } else alert(data.error || 'Failed to post comment.');
    });
  });

  // Handle like/dislike clicks
  reactionButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const reviewId = btn.dataset.reviewId;
      const type = btn.dataset.type;
      const res = await fetch('/react-review', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ review_id: reviewId, type })
      });
      const data = await res.json();
      if (data.success) await updateReactions(reviewId);
      else alert(data.error || 'Failed to react.');
    });
  });
});

// Update comments count + content
async function updateComments(reviewId, options={}) {
  const { loadOnlyCount=false } = options;
  try {
    const res = await fetch(`/get-comments/${reviewId}`);
    const comments = await res.json();
    document.getElementById(`comment-count-${reviewId}`).textContent = comments.length;

    if (loadOnlyCount) return;

    const container = document.getElementById(`comments-${reviewId}`);
    container.innerHTML = comments.length ? comments.map(c => `
      <div class="d-flex align-items-start mb-2">
        <img src="${c.profile_picture_url}" class="rounded-circle me-2" width="32" height="32" alt="User">
        <div>
          <strong><a href="/profile/${c.username}" class="text-decoration-none">${c.username}</a></strong>
          <p class="mb-0">${c.content}</p>
          <small class="text-muted">${new Date(c.created_at).toLocaleString()}</small>
          <div class="d-flex gap-2 mt-1">
            <button class="comment-reaction-btn" data-comment-id="${c.comment_id}" data-type="like">ğŸ‘ <span id="comment-like-count-${c.comment_id}">0</span></button>
            <button class="comment-reaction-btn" data-comment-id="${c.comment_id}" data-type="dislike">ğŸ‘ <span id="comment-dislike-count-${c.comment_id}">0</span></button>
          </div>
        </div>
      </div>
    `).join('') : '<p class="text-muted">No comments yet.</p>';

    // Attach comment reaction handlers
    container.querySelectorAll('.comment-reaction-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const commentId = btn.dataset.commentId;
        const type = btn.dataset.type;
        const res = await fetch('/react-comment', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ comment_id: commentId, type })
        });
        const data = await res.json();
        if(data.success) await updateCommentReactions(commentId);
      });
    });

    // Update reactions for newly rendered comments
    comments.forEach(c => updateCommentReactions(c.comment_id));

  } catch(err){ console.error(err); }
}

// Update post reaction counts
async function updateReactions(reviewId){
  try{
    const res = await fetch(`/get-review-reactions/${reviewId}`);
    const data = await res.json();
    document.getElementById(`review-like-count-${reviewId}`).textContent = data.likes;
    document.getElementById(`review-dislike-count-${reviewId}`).textContent = data.dislikes;
  }catch(err){console.error(err);}
}

// Update comment reaction counts
async function updateCommentReactions(commentId){
  try{
    const res = await fetch(`/get-comment-reactions/${commentId}`);
    const data = await res.json();
    document.getElementById(`comment-like-count-${commentId}`).textContent = data.likes;
    document.getElementById(`comment-dislike-count-${commentId}`).textContent = data.dislikes;
  }catch(err){console.error(err);}
}
</script>