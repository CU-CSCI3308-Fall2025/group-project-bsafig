<!-- TEST MESSAGE FOR AUTH -->
{{> message}}

<div class="container mt-4" style="max-width: 700px;">
  <h2 class="mb-4 text-center">Recent Reviews</h2>

  {{#if reviews.length}}
    {{#each reviews}}
      <div class="card mb-3 shadow-sm rounded-3">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <img src="{{this.profile_picture_url}}" 
                 alt="Profile Picture" 
                 class="rounded-circle me-2"
                 width="40" height="40">
            <strong>
              <a href="/profile/{{this.username}}" class="text-decoration-none">{{this.username}}</a>
            </strong>
          </div>

          <h5 class="card-title">{{this.music_name}}</h5>
          <p class="card-text">{{this.content}}</p>
          <p class="text-muted mb-0">Rating: {{this.rating}} / 10</p>
          <small class="text-muted">{{this.created_at}}</small>

          <hr>

          <!-- Comments Toggle Button -->
          <button 
            class="btn btn-outline-secondary btn-sm mb-2 comment-toggle" 
            data-review-id="{{this.review_id}}">
            ðŸ’¬ Comments (<span id="comment-count-{{this.review_id}}">0</span>)
          </button>

          <!-- Collapsible Comments Wrapper -->
          <div id="comments-wrapper-{{this.review_id}}" class="collapse">
            <div id="comments-{{this.review_id}}" class="comments mb-2"></div>

            <!-- Comment Form -->
            <form class="comment-form" data-review-id="{{this.review_id}}">
              <div class="input-group mb-2">
                <input type="text" name="content" class="form-control" placeholder="Add a comment..." required>
                <button class="btn btn-primary" type="submit">Post</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {{/each}}
  {{else}}
    <p class="text-center text-muted">No reviews have been posted yet.</p>
  {{/if}}
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const forms = document.querySelectorAll('.comment-form');

  // Load comment counts initially
  for (const form of forms) {
    const reviewId = form.dataset.reviewId;
    await updateComments(reviewId, { loadOnlyCount: true });
  }

  // Toggle dropdown behavior
  document.querySelectorAll('.comment-toggle').forEach(btn => {
    btn.addEventListener('click', async () => {
      const reviewId = btn.dataset.reviewId;
      const wrapper = document.getElementById(`comments-wrapper-${reviewId}`);

      wrapper.classList.toggle('show');

      // If opening, load comments
      if (wrapper.classList.contains('show')) {
        await updateComments(reviewId);
      }
    });
  });

  // Handle posting a comment
  forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const reviewId = form.dataset.reviewId;
      const input = form.querySelector('input[name="content"]');
      const content = input.value.trim();

      if (!content) return;

      const res = await fetch('/add-comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ review_id: reviewId, content })
      });

      const data = await res.json();

      if (data.success) {
        input.value = '';
        await updateComments(reviewId);  // refresh comments + count
      } else {
        alert(data.error || 'Failed to post comment.');
      }
    });
  });
});


/**
 * Loads comments and updates the visible count.
 * If loadOnlyCount = true, only updates the count (no rendering).
 */
async function updateComments(reviewId, options = {}) {
  const { loadOnlyCount = false } = options;

  try {
    const res = await fetch(`/get-comments/${reviewId}`);
    const comments = await res.json();

    // Update comment count
    const countEl = document.getElementById(`comment-count-${reviewId}`);
    countEl.textContent = comments.length;

    if (loadOnlyCount) return;

    // Render comments into container
    const container = document.getElementById(`comments-${reviewId}`);
    container.innerHTML = comments.length
      ? comments.map(c => `
          <div class="d-flex align-items-start mb-2">
            <img src="${c.profile_picture_url}" class="rounded-circle me-2" width="32" height="32" alt="User">
            <div>
              <strong><a href="/profile/${c.username}" class="text-decoration-none">${c.username}</a></strong>
              <p class="mb-0">${c.content}</p>
              <small class="text-muted">${new Date(c.created_at).toLocaleString()}</small>
            </div>
          </div>
        `).join('')
      : '<p class="text-muted">No comments yet.</p>';

  } catch (err) {
    console.error('Failed to load comments:', err);
  }
}
</script>